#!/usr/bin/env php
<?php

declare(strict_types=1);

require getcwd() . '/vendor/autoload.php';
// require getcwd() . '/config/bootstrap.php';

// use Delirium\Core\Application;
use Delirium\Core\Console\Kernel;
use Delirium\Core\Container\ContainerFactory;
use Delirium\Core\AppOptions;
use Delirium\Core\Foundation\ProviderRepository;
use Psr\Container\ContainerInterface;

// $publicIndex = '/public/index.php';
// $optionFile = '--file=';

// if (in_array($argv[1], ['server:start', 'server:watch'])) {
//     $publicIndexArgs = array_filter($argv, fn ($arg) => str_starts_with($arg, $optionFile));
//     if ($publicIndexArgs) {
//         $publicIndexKey = key($publicIndexArgs);
//         $publicIndex = substr($argv[$publicIndexKey], strlen($optionFile));

//         unset($argv[$publicIndexKey]);

//         $_SERVER['argv'] = $argv;
//         $GLOBALS['argv'] = $argv;
//         $argc = count($argv);
//         $_SERVER['argc'] = $argc;
//         $GLOBALS['argc'] = $argc;

//         $argv = array_values($argv);
//     }
// }

// $app = require getcwd() . '/' . ltrim($publicIndex, '/');

// if (!$app instanceof Application) {
//     echo "Error: public/index.php did not return an Application instance.\n";
//     exit(1);
// }

// 1. Create a minimal container for console context
$environment = getenv('APP_ENV') ?: 'prod';
$factory = new ContainerFactory();
$options = new AppOptions(
    new Delirium\Core\Options\DebugOptions(debug: $environment === 'dev')
);

// 2. Discover Module Class dynamically
$moduleClass = null;
$srcDir = getcwd() . '/src';
if (is_dir($srcDir)) {
    $iterator = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($srcDir));
    foreach ($iterator as $file) {
        if ($file->isFile() && str_ends_with($file->getFilename(), 'Module.php')) {
            $content = file_get_contents($file->getPathname());
            $namespace = '';
            if (preg_match('/namespace\s+([^;]+);/', $content, $matches)) {
                $namespace = trim($matches[1]);
            }
            $className = $file->getBasename('.php');
            $fullClass = ($namespace ? $namespace . '\\' : '') . $className;

            if (class_exists($fullClass)) {
                $moduleClass = $fullClass;
                // If we find AppModule.php in the root, prioritize it
                if ($className === 'AppModule') {
                    break;
                }
            }
        }
    }
}

if (!$moduleClass) {
    echo "Error: No Module class found in src/ directory (expected *Module.php).\n";
    exit(1);
}

// Ensure the class exists to avoid crash, or handle exception via try-catch around create
try {
    $container = $factory->create($moduleClass, $options);
} catch (\Throwable $e) {
    echo "Error creating container: " . $e->getMessage() . "\n";
    echo "Ensure a valid Module class exists in src/ (e.g., AppModule.php).\n";
    exit(1);
}

// 2. Create Console Kernel (registers itself as singleton)
$kernel = new Kernel();

// 3. Initialize RegenerationRegistry for cache warming
$regenerationRegistry = new \Delirium\Core\Foundation\Cache\RegenerationRegistry();

// 4. Bootstrap providers (they can access Kernel::getInstance())
$cacheFile = getcwd() . '/var/cache/discovery.php';
$repository = new ProviderRepository($container, $cacheFile, $environment);

// Register repository and registry in container so commands can access them
/** @var \Symfony\Component\DependencyInjection\ContainerBuilder $container */
if (method_exists($container, 'set')) {
    $container->set(ProviderRepository::class, $repository);
    $container->set(\Delirium\Core\Foundation\Cache\RegenerationRegistry::class, $regenerationRegistry);
}

// 5. Register Core Commands and wire dependencies
// This logic has been moved to Kernel::initializeConsole
$kernel->initializeConsole(
    $container,
    $regenerationRegistry,
    $repository,
    $factory,
    $moduleClass,
    $options
);

// 6. Register DevTools provider (in dev only)
if ($environment === 'dev') {
    $repository->register(\Delirium\DevTools\DevToolsServiceProvider::class, 'dev');
}

// Load and boot providers
$repository->load();
$repository->boot();

// 3. Run Console Application
exit($kernel->run());
